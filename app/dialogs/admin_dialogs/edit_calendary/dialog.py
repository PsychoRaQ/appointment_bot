# –∞–∏–æ–≥—Ä–∞–º
from aiogram import F
from aiogram_dialog import Dialog, Window
from aiogram_dialog.widgets.kbd import Button, Row, Back, Next, Cancel, SwitchTo, Radio
from aiogram_dialog.widgets.text import Const, Format
# –∏–º–ø–æ—Ä—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–π
from app.fsm.admin_states import AdminEditCalendary
# –∏–º–ø–æ—Ä—Ç —Å–µ—Ä–≤–∏—Å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π-–±–∏–ª–¥–µ—Ä–æ–≤
from app.utils.widget_builder_for_dialogs import get_weekday_button, get_group
# –¥–ª—è —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–æ–∫
import operator
# –≥–µ—Ç—Ç–µ—Ä—ã
from app.dialogs.user_dialogs.make_new_appointment.getters import get_free_dates
from app.dialogs.admin_dialogs.edit_calendary.getters import get_free_times_from_date, slot_info_for_user
# —Ö—ç–Ω–¥–ª–µ—Ä—ã
from app.dialogs.admin_dialogs.edit_calendary.handlers import (admin_choose_time_slot_for_edit, admin_close_slot,
                                                               admin_choose_date_for_edit)

'''
–î–∏–∞–ª–æ–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–µ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è(–≥—Ä–∞—Ñ–∏–∫–∞) –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.
–ê–¥–º–∏–Ω –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ "—Å–ª–æ—Ç—ã"", –µ–º—É —Å—Ä–∞–∑—É –∂–µ –≤–∏–∑—É–∞–ª—å–Ω–æ –≤–∏–¥–Ω—ã –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.
–ï—Å–ª–∏ –∞–¥–º–∏–Ω —Ö–æ—á–µ—Ç —Å–¥–µ–ª–∞—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º "—Å–ª–æ—Ç" –∫ –∫–æ—Ç–æ—Ä–æ–º—É –ø—Ä–∏–≤—è–∑–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
–æ–± –æ—Ç–º–µ–Ω–µ –µ–≥–æ –∑–∞–ø–∏—Å–∏ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π "—Å–ª–æ—Ç".

–ö–∞–ª–µ–Ω–¥–∞—Ä–∏ —Å –¥–∞—Ç–∞–º–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –º–æ–º–µ–Ω—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω—É–∂–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–∏–∞–ª–æ–≥–∞.
- –î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü –∏ —Å–ª–µ–¥—É—é—â–∏–π.
- –î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ –¥–∞—Ç—ã, –æ–¥–Ω–∞–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–∞—Ç—ã —Å "—Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ" –¥–Ω—è –∏ –¥–∞–ª–µ–µ.

–ò–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∏ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ "—Å–ª–æ—Ç–∞–º–∏" –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –º–æ–º–µ–Ω—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω—É–∂–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–∏–∞–ª–æ–≥–∞, –∞ —Ç–∞–∫–∂–µ
–ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è.
–ê–¥–º–∏–Ω –º–æ–∂–µ—Ç —Å–∞–º –≤—ã–±—Ä–∞—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ–∫ –º–µ–∂–¥—É –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ "—Å–ª–æ—Ç–∞–º–∏" (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - 30 –º–∏–Ω—É—Ç).
–í—Ä–µ–º–µ–Ω–Ω—ã–µ "—Å–ª–æ—Ç—ã" –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 06:00 - 00:00.

–í—Ä–µ–º–µ–Ω–Ω–æ–π "—Å–ª–æ—Ç" –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–¥–º–∏–Ω–æ–º.
'''

# –î–∏–∞–ª–æ–≥ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
edit_calendary_dialog = Dialog(
    # –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
    Window(
        Const(text='–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è:'),
        Button(Format(text='{current_month}'), id='month'),
        Row(*get_weekday_button()),
        get_group(admin_choose_date_for_edit, 'date', 'current_month'),  # group, –æ—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        Next(Format(text='{next_month}   ‚Üí')),
        Cancel(Const(text='‚ò∞ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é')),
        getter=get_free_dates,
        state=AdminEditCalendary.first_month
    ),
    # –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü
    Window(
        Const(text='–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è:'),
        Button(Format(text='{next_month}'), id='month', ),
        Row(*get_weekday_button()),
        get_group(admin_choose_date_for_edit, 'date', 'next_month'),  # group, –æ—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        Back(Format(text='‚Üê   {current_month}')),
        Cancel(Const(text='‚ò∞ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é')),
        getter=get_free_dates,
        state=AdminEditCalendary.second_month
    ),
    # –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö "—Å–ª–æ—Ç–æ–≤" –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—Ö –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
    Window(
        Format(text='–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ –Ω–∞ {text_date}:'),
        get_group(admin_choose_time_slot_for_edit, 'time'),  # group, –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–æ—Ç–æ–≤
        # —Ä–∞–¥–∏–æ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–µ–∂—É—Ç–∫–∞ –º–µ–∂–¥—É "—Å–ª–æ—Ç–∞–º–∏"
        Row(
            Radio(
                checked_text=Format('üîò {item[0]}'),
                unchecked_text=Format('‚ö™Ô∏è {item[0]}'),
                id='radio_times',
                item_id_getter=operator.itemgetter(1),
                items="slot_times",
            ),
        ),
        SwitchTo(Const(text='‚Üê –ù–∞–∑–∞–¥'), id='b_back', state=AdminEditCalendary.first_month),
        Cancel(Const(text='‚ò∞ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é')),
        getter=get_free_times_from_date,
        state=AdminEditCalendary.choose_time,
    ),
    Window(
        Format(text='–í–Ω–∏–º–∞–Ω–∏–µ: –Ω–∞ {text_date} - {text_time} –∑–∞–ø–∏—Å–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.\n'
                    '–ò–º—è: {username}\n'
                    '–¢–µ–ª–µ—Ñ–æ–Ω: {phone}\n\n'
                    '–ï—Å–ª–∏ –í—ã –≤—Å–µ-—Ç–∞–∫–∏ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —Å–ª–æ—Ç - –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å". –í —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ, '
                    '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ –µ–≥–æ –∑–∞–ø–∏—Å–∏.', when=~F['is_admin']),
        Format(text='–í–Ω–∏–º–∞–Ω–∏–µ: –Ω–∞ {text_date} - {text_time} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª –∑–∞–ø–∏—Å–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.\n'
                    '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: {comment}\n\n'
                    '–ï—Å–ª–∏ –í—ã –≤—Å–µ-—Ç–∞–∫–∏ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —Å–ª–æ—Ç - –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å".', when=F['is_admin']),
        Button(Const(text='–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å'), id='b_confirm', on_click=admin_close_slot),
        SwitchTo(Const(text='‚Üê –ù–∞–∑–∞–¥'), id='b_back', state=AdminEditCalendary.first_month),
        getter=slot_info_for_user,
        state=AdminEditCalendary.user_on_date,
    ),
)
